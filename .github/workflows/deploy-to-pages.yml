name: Deploy Schemas and Protocol to GitHub Pages

# Deploy both schemas and protocol to GitHub Pages for canonical URL access
on:
  push:
    branches: [main]
    paths:
      - '03-schemas/**'
      - '04-protocol/**'
      - 'docs/**'
  workflow_dispatch: # Allow manual trigger

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update schemas and protocol in docs directory
        run: |
          # The docs/ directory already contains the website
          # We just need to update the schemas and protocol subdirectories

          # Update schemas (preserve existing docs/schemas/ structure)
          echo "Updating schemas..."
          mkdir -p docs/schemas
          cp 03-schemas/*.json docs/schemas/
          echo "‚úÖ Schemas updated in docs/schemas/"

          # Create/update protocol directory
          echo "Updating protocol..."
          mkdir -p docs/protocol
          cp 04-protocol/ENVELOPE.md docs/protocol/
          cp 04-protocol/INTENTS.md docs/protocol/
          cp 04-protocol/CONFORMANCE.md docs/protocol/
          cp 04-protocol/envelope.schema.json docs/protocol/
          cp -r 04-protocol/LIFECYCLES docs/protocol/
          cp -r 04-protocol/FLOWS docs/protocol/
          cp -r 04-protocol/EXAMPLES docs/protocol/
          echo "‚úÖ Protocol updated in docs/protocol/"

          # Create protocol index if it doesn't exist
          if [ ! -f "docs/protocol/index.html" ]; then
            cat > docs/protocol/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>QuestFoundry Protocol</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
              h1 { color: #2c3e50; }
              h2 { color: #34495e; margin-top: 30px; }
              ul { list-style: none; padding: 0; }
              li { margin: 8px 0; }
              a { color: #2196F3; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>QuestFoundry Protocol v0.2.1</h1>
            <p>Layer 4 protocol specifications for role-based collaboration.</p>

            <h2>Core Specifications</h2>
            <ul>
              <li><a href="ENVELOPE.md">ENVELOPE.md</a> - Message envelope specification</li>
              <li><a href="INTENTS.md">INTENTS.md</a> - Complete intent catalog</li>
              <li><a href="CONFORMANCE.md">CONFORMANCE.md</a> - Conformance requirements</li>
              <li><a href="envelope.schema.json">envelope.schema.json</a> - Envelope JSON Schema</li>
            </ul>

            <h2>Lifecycle State Machines</h2>
            <ul>
              <li><a href="LIFECYCLES/hooks.md">hooks.md</a> - Hook Card lifecycle (7 states)</li>
              <li><a href="LIFECYCLES/tu.md">tu.md</a> - Trace Unit lifecycle (6 states)</li>
              <li><a href="LIFECYCLES/gate.md">gate.md</a> - Gatecheck lifecycle (4 states)</li>
              <li><a href="LIFECYCLES/view.md">view.md</a> - View/Export lifecycle (5 states)</li>
            </ul>

            <h2>Workflow Message Sequences</h2>
            <ul>
              <li><a href="FLOWS/hook_harvest.md">hook_harvest.md</a> - Hook creation and classification</li>
              <li><a href="FLOWS/lore_deepening.md">lore_deepening.md</a> - Canon development</li>
              <li><a href="FLOWS/codex_expansion.md">codex_expansion.md</a> - Player-safe knowledge base</li>
              <li><a href="FLOWS/gatecheck.md">gatecheck.md</a> - Quality validation and merge</li>
              <li><a href="FLOWS/binding_run.md">binding_run.md</a> - Export binding</li>
              <li><a href="FLOWS/narration_dry_run.md">narration_dry_run.md</a> - PN playtesting</li>
            </ul>

            <h2>Examples and Validation</h2>
            <ul>
              <li><a href="EXAMPLES/">EXAMPLES/</a> - Complete example message suite</li>
            </ul>

            <p><a href="/">‚Üê Back to main page</a></p>
          </body>
          </html>
          EOF
            echo "‚úÖ Created docs/protocol/index.html"
          fi

          echo ""
          echo "üìÅ Pages deployment structure:"
          echo "docs/"
          echo "‚îú‚îÄ‚îÄ index.html (main website - preserved)"
          echo "‚îú‚îÄ‚îÄ architecture.md (preserved)"
          echo "‚îú‚îÄ‚îÄ CNAME (preserved)"
          echo "‚îú‚îÄ‚îÄ schemas/ (updated)"
          echo "‚îÇ   ‚îî‚îÄ‚îÄ *.schema.json"
          echo "‚îî‚îÄ‚îÄ protocol/ (updated)"
          echo "    ‚îú‚îÄ‚îÄ ENVELOPE.md"
          echo "    ‚îú‚îÄ‚îÄ INTENTS.md"
          echo "    ‚îú‚îÄ‚îÄ CONFORMANCE.md"
          echo "    ‚îú‚îÄ‚îÄ envelope.schema.json"
          echo "    ‚îú‚îÄ‚îÄ LIFECYCLES/"
          echo "    ‚îú‚îÄ‚îÄ FLOWS/"
          echo "    ‚îî‚îÄ‚îÄ EXAMPLES/"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "## üåê Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Canonical URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Main:** https://questfoundry.liesdonk.nl/" >> $GITHUB_STEP_SUMMARY
          echo "- **Schemas:** https://questfoundry.liesdonk.nl/schemas/" >> $GITHUB_STEP_SUMMARY
          echo "- **Protocol:** https://questfoundry.liesdonk.nl/protocol/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù What was updated" >> $GITHUB_STEP_SUMMARY
          echo "- Updated schemas in \`docs/schemas/\`" >> $GITHUB_STEP_SUMMARY
          echo "- Updated protocol in \`docs/protocol/\`" >> $GITHUB_STEP_SUMMARY
          echo "- Preserved existing website (index.html, architecture.md, etc.)" >> $GITHUB_STEP_SUMMARY
