# Pre-commit Hooks Setup Guide

This repository uses [pre-commit](https://pre-commit.com/) to automatically validate and format code
before commits.

## What Do These Hooks Do?

The pre-commit hooks automatically:

### 1. **Formatting (Auto-fix)**

- **Prettier**: Formats JSON and Markdown files according to `.prettierrc.json`
- **Markdownlint**: Lints and auto-fixes Markdown files according to `.markdownlint.json`
- **Trailing whitespace**: Removes trailing whitespace
- **Line endings**: Normalizes to LF (Unix-style)
- **End-of-file**: Ensures files end with a newline

### 2. **Validation (Check)**

- **JSON Schema validation**: Validates Layer 3 & 4 schemas against JSON Schema Draft 2020-12
- **JSON syntax**: Validates all JSON files have valid syntax
- **Envelope validation**: Validates Layer 4 protocol envelope examples
- **Prompt validation**: Validates Layer 5 prompt structure
- **YAML validation**: Checks YAML files for syntax errors
- **Merge conflicts**: Checks for merge conflict markers
- **Large files**: Warns about files > 1MB

## Installation

### 1. Install pre-commit

```bash
pip install pre-commit
```

Or using pipx (recommended):

```bash
pipx install pre-commit
```

### 2. Install the git hooks

From the repository root:

```bash
pre-commit install
```

This installs the hooks into `.git/hooks/pre-commit`, so they run automatically on every commit.

### 3. (Optional) Install commit-msg hooks

If you want to validate commit messages:

```bash
pre-commit install --hook-type commit-msg
```

## Usage

### Automatic (Recommended)

Once installed, hooks run automatically when you commit:

```bash
git add .
git commit -m "Your commit message"
# Hooks run automatically!
```

If any hook fails or modifies files:

1. The commit is aborted
2. Fixed files are left staged
3. Review the changes
4. Commit again

### Manual (Testing)

Run hooks on all files:

```bash
pre-commit run --all-files
```

Run a specific hook:

```bash
pre-commit run prettier --all-files
pre-commit run validate-schemas --all-files
```

Run hooks on staged files only:

```bash
pre-commit run
```

## Hook Details

### Prettier (Auto-format)

**What it does:** Formats JSON and Markdown files using Prettier

**Configuration:**

- Config: `spec-tools/.prettierrc.json`
- Ignore: `spec-tools/.prettierignore`

**Example fix:**

```json
// Before
{"foo":"bar","baz":123}

// After
{
  "foo": "bar",
  "baz": 123
}
```

### Markdownlint (Auto-fix)

**What it does:** Lints Markdown files for style consistency

**Configuration:** `spec-tools/.markdownlint.json`

**Common fixes:**

- Heading styles (ATX: `#` instead of underline)
- List indentation (2 spaces)
- Trailing spaces
- Line length (warnings only, doesn't fail)

### JSON Schema Validation

**What it does:** Validates Layer 3 and Layer 4 schemas using `qfspec-validate`

**Triggers on:**

- Changes to `03-schemas/*.schema.json`
- Changes to `04-protocol/*.schema.json`

**Requirements:**

- `uv` installed
- `spec-tools` dependencies synced (`cd spec-tools && uv sync`)

### JSON Syntax Validation

**What it does:** Validates all JSON files parse correctly using Python's `json.tool`

**Triggers on:** Any `.json` file

### Envelope Validation

**What it does:** Validates Layer 4 protocol envelope examples using two-pass validation

**Triggers on:** Changes to `04-protocol/EXAMPLES/*.json`

**Validation passes:**

1. Envelope structure (Layer 4 schema)
2. Payload data (Layer 3 schema)

### Prompt Validation

**What it does:** Validates Layer 5 prompt structure using `05-prompts/tests/validate_prompts.py`

**Triggers on:** Changes to `05-prompts/**/*.md` or `05-prompts/**/*.py`

## Troubleshooting

### Hook fails with "command not found"

**Problem:** Pre-commit can't find `uv`, `python`, or other commands.

**Solution:**

1. Ensure tools are installed and in your PATH
2. For `uv`: Install from <https://github.com/astral-sh/uv>
3. For Python: Ensure Python 3.11+ is installed

### Hook fails with "uv run qfspec-validate failed"

**Problem:** Schema validation dependencies not installed.

**Solution:**

```bash
cd spec-tools
uv sync
```

### Prettier/Markdownlint modifies files unexpectedly

**Problem:** Auto-formatting changes code style.

**Solution:**

1. Review the changes (`git diff`)
2. If acceptable, stage and commit
3. If not, adjust config files:
   - Prettier: `spec-tools/.prettierrc.json`
   - Markdownlint: `spec-tools/.markdownlint.json`

### Hook is too slow

**Problem:** Hooks take a long time on large commits.

**Solution:**

- Run hooks manually before committing: `pre-commit run --all-files`
- Skip hooks temporarily: `git commit --no-verify` (not recommended)
- Update hook to run only on changed files (if applicable)

### Disable a specific hook

Edit `.pre-commit-config.yaml` and comment out the hook:

```yaml
# - id: markdownlint  # Temporarily disabled
#   name: Lint Markdown files
```

Then update hooks:

```bash
pre-commit install
```

## Skipping Hooks (Emergency Use Only)

To skip hooks for a single commit:

```bash
git commit --no-verify -m "Emergency fix"
```

**Warning:** Only use in emergencies. Skipping hooks can introduce formatting inconsistencies and
validation errors.

## Updating Hooks

To update to the latest hook versions:

```bash
pre-commit autoupdate
```

This updates the `rev` fields in `.pre-commit-config.yaml`.

## CI/CD Integration

The same validations run in GitHub Actions (see `.github/workflows/validate.yml`).

**Key difference:** CI uses `prettier --check` (fails if not formatted), while pre-commit uses
`prettier --write` (auto-formats).

## Configuration Files

| File                            | Purpose                        |
| ------------------------------- | ------------------------------ |
| `.pre-commit-config.yaml`       | Pre-commit hook configuration  |
| `spec-tools/.prettierrc.json`   | Prettier formatting rules      |
| `spec-tools/.prettierignore`    | Files to exclude from Prettier |
| `spec-tools/.markdownlint.json` | Markdownlint rules             |

## Best Practices

1. **Install hooks immediately** after cloning: `pre-commit install`
2. **Run manually before large commits**: `pre-commit run --all-files`
3. **Review auto-formatted changes** before committing
4. **Keep hooks updated**: `pre-commit autoupdate` monthly
5. **Don't skip hooks** unless absolutely necessary

## Further Reading

- [pre-commit documentation](https://pre-commit.com/)
- [Prettier documentation](https://prettier.io/)
- [Markdownlint documentation](https://github.com/DavidAnson/markdownlint)
- [JSON Schema validation](../spec-tools/README.md)

---

**Questions?** See [CONTRIBUTING.md](../CONTRIBUTING.md) or open an issue.
